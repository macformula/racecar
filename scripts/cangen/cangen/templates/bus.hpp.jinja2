/// @author Blake Freer
/// @date November 2024

// WARNING: DO NOT MODIFY THIS CODE. THIS IS AN AUTOGENERATED FILE.

// clang-format off

#pragma once

#include <optional>

#include "can/bus.hpp"
#include "can/msg.hpp"
#include "periph/can.hpp"
#include "atomic_buffer.hpp"
#include "{{bus_name | lower}}_messages.hpp"

namespace generated::can {

{% set bus = bus_name+"Bus" %}
class {{ bus }} : public macfe  ::can::Bus {
public:
    {{ bus }}(macfe::periph::CanBase& can_base) : macfe::can::Bus(can_base) {}

    {% for msg in rx_msgs %}
    {% set msg_title = "Rx"+msg.m.name %}
    // Get the latest message of type {{msg_title}}
    inline auto Get{{msg_title}}() -> std::optional<{{msg_title}}> {
        return {{ msg.m.name | camel_to_snake }}_buffer_.Get();
    }

    // Get the latest message of type {{msg_title}} and clear the buffer.
    inline auto Pop{{msg_title}}() -> std::optional<{{msg_title}}> {
        return {{ msg.m.name | camel_to_snake }}_buffer_.Pop();
    }
    {% endfor %}

private:
    void AddMessage(const macfe::can::RawMessage& msg, uint32_t timestamp) override {
        {% if rx_msgs %}
        switch(msg.id) {
            {% for msg in rx_msgs %}
            case Rx{{msg.m.name}}::id:
                {{ msg.m.name | camel_to_snake }}_buffer_.Add(Rx{{msg.m.name}}(msg, timestamp));
                break;
            {% endfor %}
            default:
                break;  // ignore messages not intended for this node on this bus
        }
        {% else %}
        // The "{{node_name}}" CAN node does not receive any messages.
        // If this is a mistake, check that the node is:
        // 1. Set correctly in the project's config.yaml under the "{{bus_name}}" bus.
        // 2. Listed as a signal receiver in the DBC file.
        (void)msg;
        (void)timestamp;
        {% endif %}
    }
    
    {% if rx_msgs %}
    // All messages start empty and will be filled when the first instance arrives.
    {% for msg in rx_msgs %}
    macfe::AtomicBuffer<Rx{{ msg.m.name }}> {{msg.m.name | camel_to_snake}}_buffer_;
    {% endfor %}
    {% endif %}
};

} // namespace generated::can

// clang-format on
