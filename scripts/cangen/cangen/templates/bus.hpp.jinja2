/// @author Samuel Parent, Blake Freer
/// @date November 2024

// WARNING: DO NOT MODIFY THIS CODE. THIS IS AN AUTOGENERATED FILE.

// clang-format off

#include <optional>
#include <atomic>

#include "shared/comms/can/bus.hpp"
#include "shared/comms/can/msg.hpp"
#include "shared/periph/can.hpp"
#include "{{bus_name | lower}}_messages.hpp"

namespace generated::can {

{% set bus = bus_name+"Bus" %}
class {{ bus }} : public shared::can::Bus {
public:
    {{ bus }}(shared::periph::CanBase& can_base) : shared::can::Bus(can_base) {}

    {% for msg in rx_msgs %}
    {% set msg_title = "Rx"+msg.name %}
    // Get the latest message of type {{msg_title}}
    auto Get{{msg_title}}() -> std::optional<{{msg_title}}> {
        int side = static_cast<int>({{msg.name | camel_to_snake}}_side_);
        return {{ msg.name | camel_to_snake }}_msg_[side];
    }

    // Get the latest message of type {{msg_title}} and clear it
    auto Pop{{msg_title}}() -> std::optional<{{msg_title}}> {
        int side = static_cast<int>({{msg.name | camel_to_snake}}_side_);
        auto temp = {{ msg.name | camel_to_snake }}_msg_[side];
        {{ msg.name | camel_to_snake }}_msg_[side] = std::nullopt;
        return temp;
    }
    {% endfor %}

private:
    void AddMessage(const shared::can::RawMessage& msg, uint32_t timestamp) override {
        int new_side;
        switch(msg.id) {
            {% for msg in rx_msgs %}
            case Rx{{msg.name}}::id:
                new_side = static_cast<int>(!{{msg.name | camel_to_snake}}_side_);
                {{ msg.name | camel_to_snake }}_msg_[new_side] = Rx{{msg.name}}(msg, timestamp);
                {{ msg.name | camel_to_snake }}_side_ = static_cast<bool>(new_side);
                break;
            {% endfor %}
            default:
                break;  // ignore messages not intended for this node on this bus
        }
    }
    
    // All messages start empty and will be filled when the first instance arrives.
    {% for msg in rx_msgs %}
    std::atomic_bool {{msg.name | camel_to_snake}}_side_ = false;
    std::optional<Rx{{ msg.name }}> {{msg.name | camel_to_snake}}_msg_[2] = {std::nullopt, std::nullopt};
    {% endfor %}

    friend class Base;
};

} // namespace generated::can

// clang-format on