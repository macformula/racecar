/// @author Samuel Parent, Blake Freer
/// @date November 2024

// WARNING: DO NOT MODIFY THIS CODE. THIS IS AN AUTOGENERATED FILE.

/// @todo support enums
/// @todo clang format

// clang-format off

#pragma once

#include <cstdint>
#include "shared/comms/can/msg.hpp"

namespace generated::can {

{% set bus = bus_name+"Bus" %}
class {{ bus }};

/* -------------------- ENUMS -------------------- */
{% for msg in tx_msgs + rx_msgs %}
    {% for sig in msg.signals %}
        {% if sig.s.choices %}  
enum class {{ sig.s.name }} {
            {% for value, name in sig.s.choices.items() | reverse %}
    {{ name }} = {{ value }},
            {% endfor %}
};
        {% endif %}
    {% endfor %}
{% endfor %}

/* -------------------- RX MESSAGES -------------------- */

{% for msg in rx_msgs %}
{% set class_name = "Rx"+msg.m.name %}
class {{ class_name }} {
public:
    {% for sig in msg.signals %}
    inline {{ sig.type }} {{ sig.s.name }}() const { return {{ sig.name }}_; }
    {% endfor %}

private:
    {% for sig in msg.signals %}
    {{ sig.type }} {{ sig.name }}_;
    {% endfor %}

    // Timestamp is platform dependent. See mcal/PLATFORM/periph/can
    uint32_t timestamp_;

    constexpr static uint32_t id = {{ msg.m.frame_id }};
    constexpr static uint8_t data_length = {{ msg.m.length }};


    friend class {{ bus }};
    
    // Only {{ bus }} can construct this class which guarantees the data came from the CAN line.
    {{ class_name }}(shared::can::RawMessage raw_msg, uint32_t timestamp) : timestamp_(timestamp) {
        {% for sig in msg.signals %}
        {% set T = sig.temp_type %}
        {{ T }} temp_{{ sig.name }} = 0;
        {% for mask in sig.masks %}
            {% set i = loop.index0 %}
            {% set shift = sig.shifts[i] %}
            {% if mask != 0 %}
                {% if T == "bool" %}
        temp_{{ sig.name }} = raw_msg.data[{{ i }}] & {{mask | hex}};
                {% else %}
                    {% if shift >= 0 %}
        temp_{{ sig.name }} |= static_cast<{{T}}>(raw_msg.data[{{ i }}] & {{mask | hex}}) << {{ shift }};
                    {% else %}
        temp_{{ sig.name }} |= static_cast<{{T}}>(raw_msg.data[{{ i }}] & {{ mask | hex }}) >> {{ -shift }};
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
        {% if sig.s.scale == 1 and sig.s.offset == 0 %}
        {{ sig.name }}_ = temp_{{ sig.name }};
        {% else %}
        {{ sig.name }}_ = static_cast<{{ T }}>(static_cast<double>(temp_{{ sig.name }}) * {{ sig.s.scale }} + {{ sig.s.offset }});
        {% endif %}
        
        {% endfor %}
    }
    {{ class_name }}() = delete;
};


{% endfor %}

/* -------------------- TX MESSAGES -------------------- */

{% for msg in tx_msgs %}
{% set class_name = "Tx"+msg.m.name %}
class {{ class_name }} {
public:
    {% for sig in msg.signals %}
    {{ sig.type }} {{ sig.name }};
    {% endfor %}

    shared::can::RawMessage pack() const {
        uint8_t data[{{msg.m.length}}] = {};

        // @todo clamp data

        // temporary signal variables
        {% for sig in msg.signals %}
        {{ sig.type }} temp_{{ sig.name | camel_to_snake }} = static_cast<{{ sig.type }}>(static_cast<double>({{ sig.name }} - {{ sig.s.offset }} ) / {{ sig.s.scale }});
        {% endfor %}

        {% for sig in msg.signals %}
        {% for mask in sig.masks %}
            {% set i = loop.index0 %}
            {% set shift = sig.shifts[i] %}
            {% if mask != 0 %}
                {% if shift >= 0 %}
        data[{{ i }}] |= shared::can::pack_right_shift(temp_{{ sig.name }}, {{ shift }}U, {{ mask | hex }}U);
                {% else %}
        data[{{ i }}] |= shared::can::pack_left_shift(temp_{{ sig.name }}, {{ -(shift) }}U, {{ mask | hex }}U);
                {% endif %}
            {% endif %}
        {% endfor %}
        {% endfor %}

        return shared::can::RawMessage(id, extended_frame, data_length, data);
    }

private:
    static constexpr uint32_t id = {{ msg.m.frame_id }};
    static constexpr uint8_t data_length = {{ msg.m.length }};
    constexpr static uint8_t extended_frame = {{ msg.m.is_extended_frame | lower }};
};


{% endfor %}

}  // namespace generated::can

// clang-format on