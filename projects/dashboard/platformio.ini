[platformio]
name = "Dashboard"
description = "The primary driver interface. Has a 10 cm screen with 2 buttons."
default_envs = vehicle

[env]
build_type = debug
debug_build_flags = -g

[common]
lib_deps =
    Embedded Template Library@^20
    cangen=file://../../scripts/cangen
    ; Use direct URL, because package registry is unstable
    lvgl@9.3
lib_archive = false

build_src_filter =
    +<**/*.*>
    ; Exclude top-level platforms/ and mcal/ - each `env` will re-add what it needs
    -<platforms/>
    -<mcal/>
flags = 
    -std=c++20
    ; -Werror ; Disabled - LVGL bug
    -Wall
    -Wno-unused-function ;  having problems with unused MPU_Config()
    -D LV_BUILD_TEST=0

[env:vehicle]
platform = ststm32
platform_packages = platformio/toolchain-gccarmnoneeabi@^1.140201.0
framework = stm32cube
board = disco_f469ni
upload_protocol = stlink

lib_deps = 
    ${common.lib_deps}

lib_ignore =
    lvgl/src/draw/sw/blend/helium
    lvgl/src/draw/sw/blend/neon

extra_scripts =
    pre:../../scripts/build/add_hardfloat.py
    pre:exclude_helium.py

build_src_filter =
    ${common.build_src_filter}
    +<platforms/stm32>
    +<mcal/stm32f>
    ; -<platforms/stm32/hal_stm_lvgl>

build_flags =
    ${common.flags}
    -I src/platforms/stm32/Core/Inc
    -I src/platforms/stm32/BSP
    -D LV_CONF_PATH=\"platforms/stm32/lv_conf.h\"
    -D LV_USE_DRAW_SW_ASM=LV_DRAW_SW_ASM_NONE
    -D LV_USE_DRAW_SW_ASM_HELIUM=0
    -D LV_USE_DRAW_SW_ASM_NEON=0

build_unflags =
    -D__ARM_FEATURE_MVE
    -D__ARM_FEATURE_DSP

board_build.ldscript = src/platforms/stm32/SDRAM.ld
board_build.stm32cube.custom_config_header = yes

[env:linux]
platform = native

lib_ignore =
    lvgl/src/draw/sw/blend/helium
    lvgl/src/draw/sw/blend/neon

build_src_filter =
    ${common.build_src_filter}
    +<platforms/linux>
    +<mcal/linux>
    -<**/.venv> ; PlatformIO looks at python venvs for some reason

build_flags =
    ${common.flags}
    -I src/platforms/linux
    -D LV_LVGL_H_INCLUDE_SIMPLE=1
    -D LV_CONF_INCLUDE_SIMPLE=1
    -D SIMULATOR=1
    -D LV_USE_DRAW_SW_ASM=LV_DRAW_SW_ASM_NONE
    -l SDL2
build_unflags =
    -D__ARM_FEATURE_MVE
    
extra_scripts =
    pre:exclude_helium.py
lib_deps = 
    ${common.lib_deps}
